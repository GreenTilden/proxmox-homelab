import{I as O,d as te,r as b,k as oe,Q as se,a as S,e as A,o as M,b as o,n as c,t as w,F as re,j as ne,i as le,c as m,l as K,_ as ie,a4 as ce,q as H}from"./index-BLBEzzhA.js";import{_ as ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{P as N}from"./useTheme-DufHymFi.js";/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=s=>s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),ue=s=>s.replace(/^([A-Z])|[\s-_]+(\w)/g,(a,l,t)=>t?t.toUpperCase():l.toLowerCase()),de=s=>{const a=ue(s);return a.charAt(0).toUpperCase()+a.slice(1)},me=(...s)=>s.filter((a,l,t)=>!!a&&a.trim()!==""&&t.indexOf(a)===l).join(" ").trim();/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var G={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":2,"stroke-linecap":"round","stroke-linejoin":"round"};/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=({size:s,strokeWidth:a=2,absoluteStrokeWidth:l,color:t,iconNode:y,name:k,class:p,...x},{slots:f})=>O("svg",{...G,width:s||G.width,height:s||G.height,stroke:t||G.stroke,"stroke-width":l?Number(a)*24/Number(s):a,class:me("lucide",...k?[`lucide-${W(de(k))}-icon`,`lucide-${W(k)}`]:["lucide-icon"]),...x},[...y.map(d=>O(...d)),...f.default?[f.default()]:[]]);/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=(s,a)=>(l,{slots:t})=>O(pe,{...l,iconNode:a,name:s},t);/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=B("activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]);/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=B("code",[["path",{d:"m16 18 6-6-6-6",key:"eg8j8"}],["path",{d:"m8 6-6 6 6 6",key:"ppft3o"}]]);/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=B("database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]]);/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=B("download",[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]]);/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=B("folder",[["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]]);/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=B("play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=B("server",[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]]);/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=B("shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]);/**
 * @license lucide-vue-next v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=B("trending-up",[["path",{d:"M16 7h6v6",key:"box55l"}],["path",{d:"m22 7-8.5 8.5-5-5L2 17",key:"1t1m79"}]]),we={key:0,class:"service-metrics"},xe={key:0,class:"metrics-grid"},_e={class:"metric-item"},ke={class:"metric-bar"},Me={class:"metric-value"},Se={class:"metric-item"},Ce={class:"metric-bar"},Te={class:"metric-value"},$e={class:"metric-item"},qe={class:"metric-value"},Ae={key:1,class:"metrics-grid"},Be={class:"metric-label"},Ee={class:"metric-bar"},Re={class:"metric-value"},Ie={key:2,class:"metrics-grid"},je={class:"metric-item"},ze={class:"metric-value"},Pe={class:"metric-item"},Fe={class:"metric-bar"},Ue={class:"metric-value"},De={class:"metric-item"},He={class:"metric-bar"},Ve={class:"metric-value"},Le={key:3,class:"metrics-grid"},Ge={class:"metric-item"},Oe={class:"metric-value"},Ze={class:"metric-item"},Ke={class:"metric-value"},Ne={class:"metric-item"},We={class:"metric-value"},Ye=te({__name:"ServiceMetrics",props:{serviceId:{},showMetrics:{type:Boolean,default:!0}},setup(s){const a=s,l=b(0),t=b(0),y=b("0.0"),k=b([]),p=b(0),x=b(0),f=b(0);b(0),b(0),b(0);const d=b(0),j=b(0),z=b(0),P=b(0);let I=null;const T=(u,r)=>u>r?"#ff0000":u>r*.7?"#ffff00":"#00ff00",E=u=>{if(u===0)return"0 B";const r=1024,_=["B","KB","MB","GB"],e=Math.floor(Math.log(u)/Math.log(r));return parseFloat((u/Math.pow(r,e)).toFixed(1))+" "+_[e]},F=async()=>{try{const r=await(await fetch('http://192.168.0.99:9090/api/v1/query?query=100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)')).json();r.status==="success"&&r.data.result.length>0&&(l.value=parseFloat(r.data.result[0].value[1]));const e=await(await fetch("http://192.168.0.99:9090/api/v1/query?query=(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100")).json();e.status==="success"&&e.data.result.length>0&&(t.value=parseFloat(e.data.result[0].value[1]));const h=await(await fetch("http://192.168.0.99:9090/api/v1/query?query=node_load1")).json();h.status==="success"&&h.data.result.length>0&&(y.value=parseFloat(h.data.result[0].value[1]).toFixed(1))}catch(u){console.warn("Failed to fetch node metrics:",u)}},V=async()=>{try{const r=await(await fetch("http://192.168.0.99:9090/api/v1/query?query=zfs_pool_capacity_percent")).json();r.status==="success"&&(k.value=r.data.result.map(_=>({name:_.metric.pool.replace("-pool",""),usage:parseFloat(_.value[1])})))}catch(u){console.warn("Failed to fetch ZFS metrics:",u)}},L=async()=>{try{const r=await(await fetch('http://192.168.0.99:9090/api/v1/query?query=count(container_last_seen{name!=""})')).json();r.status==="success"&&r.data.result.length>0&&(p.value=parseInt(r.data.result[0].value[1]));const e=await(await fetch('http://192.168.0.99:9090/api/v1/query?query=sum(rate(container_cpu_usage_seconds_total{name!=""}[5m])) * 100')).json();e.status==="success"&&e.data.result.length>0&&(x.value=parseFloat(e.data.result[0].value[1]));const h=await(await fetch('http://192.168.0.99:9090/api/v1/query?query=sum(container_memory_usage_bytes{name!=""})')).json();let C=0;h.status==="success"&&h.data.result.length>0&&(C=parseFloat(h.data.result[0].value[1]));const v=await(await fetch("http://192.168.0.99:9090/api/v1/query?query=node_memory_MemTotal_bytes")).json();if(v.status==="success"&&v.data.result.length>0){const n=parseFloat(v.data.result[0].value[1]);n>0&&(f.value=C/n*100)}}catch(u){console.warn("Failed to fetch container metrics:",u)}},U=async()=>{try{const r=await(await fetch("http://192.168.0.99:9090/api/v1/targets")).json();r.status==="success"&&(j.value=r.data.activeTargets.length,d.value=r.data.activeTargets.filter(_=>_.health==="up").length),z.value=Math.floor(Math.random()*200)+400,P.value=Math.random()*1e8+5e7}catch(u){console.warn("Failed to fetch Prometheus metrics:",u)}},$=async()=>{switch(a.serviceId){case"node-exporter":await F();break;case"zfs-exporter":await V();break;case"cadvisor":await L();break;case"prometheus":await U();break}};return oe(()=>{$(),I=setInterval($,3e4)}),se(()=>{I&&clearInterval(I)}),(u,r)=>s.showMetrics?(M(),S("div",we,[s.serviceId==="node-exporter"?(M(),S("div",xe,[o("div",_e,[r[0]||(r[0]=o("span",{class:"metric-label"},"CPU",-1)),o("div",ke,[o("div",{class:"bar-fill",style:c({width:l.value+"%",backgroundColor:T(l.value,80)})},null,4)]),o("span",Me,w(l.value.toFixed(1))+"%",1)]),o("div",Se,[r[1]||(r[1]=o("span",{class:"metric-label"},"MEM",-1)),o("div",Ce,[o("div",{class:"bar-fill",style:c({width:t.value+"%",backgroundColor:T(t.value,85)})},null,4)]),o("span",Te,w(t.value.toFixed(1))+"%",1)]),o("div",$e,[r[2]||(r[2]=o("span",{class:"metric-label"},"LOAD",-1)),o("span",qe,w(y.value),1)])])):s.serviceId==="zfs-exporter"?(M(),S("div",Ae,[(M(!0),S(re,null,ne(k.value,_=>(M(),S("div",{key:_.name,class:"metric-item"},[o("span",Be,w(_.name),1),o("div",Ee,[o("div",{class:"bar-fill",style:c({width:_.usage+"%",backgroundColor:T(_.usage,90)})},null,4)]),o("span",Re,w(_.usage.toFixed(0))+"%",1)]))),128))])):s.serviceId==="cadvisor"?(M(),S("div",Ie,[o("div",je,[r[3]||(r[3]=o("span",{class:"metric-label"},"Containers",-1)),o("span",ze,w(p.value),1)]),o("div",Pe,[r[4]||(r[4]=o("span",{class:"metric-label"},"CPU",-1)),o("div",Fe,[o("div",{class:"bar-fill",style:c({width:x.value+"%",backgroundColor:T(x.value,70)})},null,4)]),o("span",Ue,w(x.value.toFixed(1))+"%",1)]),o("div",De,[r[5]||(r[5]=o("span",{class:"metric-label"},"MEM",-1)),o("div",He,[o("div",{class:"bar-fill",style:c({width:f.value+"%",backgroundColor:T(f.value,80)})},null,4)]),o("span",Ve,w(f.value.toFixed(1))+"%",1)])])):s.serviceId==="prometheus"?(M(),S("div",Le,[o("div",Ge,[r[6]||(r[6]=o("span",{class:"metric-label"},"Targets",-1)),o("span",Oe,w(d.value)+"/"+w(j.value),1)]),o("div",Ze,[r[7]||(r[7]=o("span",{class:"metric-label"},"Scrapes",-1)),o("span",Ke,w(z.value)+"/min",1)]),o("div",Ne,[r[8]||(r[8]=o("span",{class:"metric-label"},"Storage",-1)),o("span",We,w(E(P.value)),1)])])):A("",!0)])):A("",!0)}}),Qe=ae(Ye,[["__scopeId","data-v-18883bb8"]]),Je={key:2},Xe=["href"],et="●",tt="○",st="◐",at="▲",ot="■",X="?",rt=te({__name:"ServiceCard",props:{service:{},elevation:{default:"medium"},borderStyle:{default:"gradient"},glowEffect:{type:Boolean,default:!0},compactMode:{type:Boolean,default:!1}},emits:["open"],setup(s){const a=s,l=le("fallTheme"),{theme:t}=l,y=b(!1),k={prometheus:Y,"node-exporter":J,cadvisor:he,"zfs-exporter":Y,"qbittorrent-exporter":Q,plex:fe,grafana:be,qbittorrent:Q,filebrowser:ye,proxmox:J,"code-server":ve},p=m(()=>k[a.service.id]||ge),x=m(()=>["node-exporter","zfs-exporter","cadvisor","prometheus"].includes(a.service.id)),f=g=>{var Z;const n=((Z=t.value.primary)==null?void 0:Z.ramp3)||g;return`hue-rotate(${Object.keys(N).includes(n)?N[n]:0}deg) saturate(0.8) brightness(0.95)`},d=m(()=>{const g=[t.value.primary.ramp1,t.value.primary.ramp2,t.value.primary.ramp3,t.value.primary.ramp4,t.value.primary.ramp5,t.value.secondary.ramp1,t.value.secondary.ramp3,t.value.accent.ramp2],v=a.service.id.length%g.length,n=g[v];switch(a.service.status){case"online":return{bg:t.value.status.success,border:n,text:t.value.text.bright,glow:n+"40"};case"offline":return{bg:t.value.status.error,border:n,text:t.value.text.bright,glow:n+"40"};case"checking":return{bg:t.value.status.warning,border:n,text:t.value.text.primary,glow:n+"40"};case"warning":return{bg:t.value.status.warning,border:n,text:t.value.text.bright,glow:n+"40"};case"error":return{bg:t.value.status.error,border:n,text:t.value.text.bright,glow:n+"40"};case"unknown":default:return{bg:t.value.neutral.ramp3,border:n,text:t.value.text.bright,glow:n+"40"}}}),j=m(()=>({background:"rgba(135, 93, 88, 0.1)",border:a.borderStyle==="gradient"?`4px solid ${d.value.border}`:`4px solid ${d.value.border}`,borderRadius:"0px",padding:a.compactMode?"var(--space-md)":"var(--space-lg)",position:"relative",overflow:"hidden",cursor:"default",transition:"all var(--transition-normal)",backdropFilter:"blur(1px)",imageRendering:"pixelated",boxShadow:y.value?`
      0 8px 32px ${t.value.effects.shadow},
      0 0 20px ${d.value.glow},
      inset 3px 3px 0px ${t.value.text.primary}40,
      inset -3px -3px 0px ${t.value.effects.shadow},
      4px 4px 0px ${d.value.border}80
    `:`
      0 4px 12px ${t.value.effects.shadow},
      inset 2px 2px 0px ${t.value.text.primary}20,
      inset -2px -2px 0px ${t.value.effects.shadow},
      2px 2px 0px ${d.value.border}60
    `,transform:y.value?"translateY(-2px)":"translateY(0)",borderColor:y.value?d.value.border:d.value.border+"60"})),z=m(()=>({position:"absolute",top:"0",left:"0",right:"0",height:"2px",background:`linear-gradient(90deg, transparent, ${d.value.border}, transparent)`,opacity:y.value?"1":"0",transition:"opacity var(--transition-normal)",filter:f(d.value.border)})),P=m(()=>({display:"flex",alignItems:"flex-start",justifyContent:"space-between",marginBottom:"var(--space-md)"})),I=m(()=>({display:"flex",alignItems:"flex-start",gap:"var(--space-sm)",flex:"1"})),T=m(()=>({width:"16px",height:"16px",color:t.value.primary.ramp4,marginTop:"2px",filter:`drop-shadow(0 0 4px ${t.value.primary.ramp4}40)`})),E=m(()=>({fontSize:"0.875rem",fontWeight:"600",color:t.value.text.bright,margin:"0",lineHeight:"1.25"})),F=m(()=>({fontSize:"0.75rem",color:t.value.text.muted,margin:"4px 0 0 0",lineHeight:"1.25",opacity:"0.8"})),V=m(()=>({width:"24px",height:"24px",borderRadius:"0px",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px",fontWeight:"bold",background:d.value.bg,border:`2px solid ${d.value.border}`,color:d.value.text,flexShrink:"0",imageRendering:"pixelated",animation:a.service.status==="checking"?"blink 1s infinite":"none",boxShadow:a.glowEffect?`
      0 0 8px ${d.value.glow},
      inset 1px 1px 0px rgba(255,255,255,0.3),
      inset -1px -1px 0px rgba(0,0,0,0.3)
    `:`
      inset 1px 1px 0px rgba(255,255,255,0.2),
      inset -1px -1px 0px rgba(0,0,0,0.2)
    `,textShadow:a.service.status==="checking"?"none":"1px 1px 0px rgba(0,0,0,0.5)",transition:"all 0.2s ease"})),L=m(()=>{switch(a.service.status){case"online":return et;case"offline":return tt;case"checking":return st;case"warning":return at;case"error":return ot;case"unknown":return X;default:return X}}),U=m(()=>({display:"flex",flexDirection:"column",gap:"var(--space-xs)",marginBottom:"var(--space-md)"})),$=m(()=>({display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:"0.75rem"})),u=m(()=>({color:t.value.text.muted,opacity:"0.8"})),r=m(()=>({color:t.value.primary.ramp4,fontWeight:"500"}));m(()=>({marginBottom:"var(--space-md)",paddingBottom:"var(--space-sm)",borderBottom:`1px solid ${t.value.neutral.ramp3}30`})),m(()=>({fontSize:"0.75rem",color:t.value.text.muted,opacity:"0.6",textAlign:"center"}));const _=m(()=>({display:"flex",flexDirection:"column",gap:"var(--space-xs)",marginTop:"var(--space-md)",paddingTop:"var(--space-sm)",borderTop:`1px solid ${t.value.neutral.ramp3}30`})),e=m(()=>({fontSize:"0.7rem",color:t.value.text.muted,opacity:"0.8"})),i=m(()=>({fontSize:"0.75rem",color:t.value.primary.ramp4,fontFamily:"monospace",wordBreak:"break-all",textDecoration:"none",cursor:"pointer",transition:"all var(--transition-fast)",display:"inline-block",padding:"2px 4px",borderRadius:"2px","&:hover":{color:t.value.primary.ramp5,background:`${t.value.primary.ramp4}20`,textDecoration:"underline"}})),h=g=>{const v=Math.floor(g/86400),n=Math.floor(g%86400/3600),D=Math.floor(g%3600/60);return v>0?`${v}d ${n}h`:n>0?`${n}h ${D}m`:`${D}m`},C=g=>{if(g===0)return"0 B";const v=1024,n=["B","KB","MB","GB"],D=Math.floor(Math.log(g)/Math.log(v));return parseFloat((g/Math.pow(v,D)).toFixed(1))+" "+n[D]};return(g,v)=>(M(),S("div",{class:"service-card-container",style:c(j.value),onMouseenter:v[1]||(v[1]=n=>y.value=!0),onMouseleave:v[2]||(v[2]=n=>y.value=!1)},[o("div",{style:c(z.value)},null,4),o("div",{style:c(P.value)},[o("div",{style:c(I.value)},[(M(),K(ie(p.value),{style:c(T.value)},null,8,["style"])),o("div",null,[o("h4",{class:"nes-text",style:c(E.value)},w(s.service.name),5),o("p",{class:"nes-text",style:c(F.value)},w(s.service.description),5)])],4),o("div",{style:c(V.value)},w(L.value),5)],4),s.service.metrics?(M(),S("div",{key:0,style:c(U.value)},[s.service.metrics.uptime?(M(),S("div",{key:0,style:c($.value)},[o("span",{class:"nes-text",style:c(u.value)},"Uptime:",4),o("span",{class:"nes-text",style:c(r.value)},w(h(s.service.metrics.uptime)),5)],4)):A("",!0),s.service.responseTime?(M(),S("div",{key:1,style:c($.value)},[o("span",{class:"nes-text",style:c(u.value)},"Response:",4),o("span",{class:"nes-text",style:c(r.value)},w(s.service.responseTime)+"ms",5)],4)):A("",!0),s.service.id==="qbittorrent-exporter"&&s.service.metrics.customMetrics?(M(),S("div",Je,[s.service.metrics.customMetrics.activeDownloads!==void 0?(M(),S("div",{key:0,style:c($.value)},[o("span",{style:c(u.value)},"Downloads:",4),o("span",{style:c(r.value)},w(s.service.metrics.customMetrics.activeDownloads),5)],4)):A("",!0),s.service.metrics.customMetrics.downloadSpeed?(M(),S("div",{key:1,style:c($.value)},[o("span",{style:c(u.value)},"⬇ Speed:",4),o("span",{style:c(r.value)},w(C(s.service.metrics.customMetrics.downloadSpeed))+"/s",5)],4)):A("",!0)])):A("",!0)],4)):A("",!0),x.value?(M(),K(Qe,{key:1,"service-id":s.service.id,"show-metrics":!0},null,8,["service-id"])):A("",!0),s.service.url?(M(),S("div",{key:2,style:c(_.value)},[o("span",{class:"nes-text",style:c(e.value)},"URL:",4),o("a",{href:s.service.url,class:"nes-text",style:c(i.value),onClick:v[0]||(v[0]=ce(n=>g.$emit("open",s.service.url),["prevent"])),target:"_blank",rel:"noopener noreferrer"},w(s.service.url),13,Xe)],4)):A("",!0)],36))}}),ut=ae(rt,[["__scopeId","data-v-b4a2f946"]]);class nt{constructor(a){this.baseUrl="http://192.168.0.99:9090",this.cache=new Map,this.requestAbortControllers=new Map,a&&(this.baseUrl=a)}async query(a,l=!0){const t=`query:${a}`;if(l){const p=this.cache.get(t);if(p&&Date.now()-p.timestamp<3e4)return p.data}const y=this.requestAbortControllers.get(t);y&&y.abort();const k=new AbortController;this.requestAbortControllers.set(t,k);try{const p=`${this.baseUrl}/api/v1/query?query=${encodeURIComponent(a)}`,x=await fetch(p,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},signal:k.signal});if(!x.ok)throw new Error(`Prometheus API error: ${x.status} ${x.statusText}`);const f=await x.json();return f.status==="success"&&this.cache.set(t,{data:f,timestamp:Date.now()}),f}catch(p){throw p.name==="AbortError"?new Error("Request cancelled"):(console.error("Prometheus query failed:",a,p),new Error(`Failed to fetch metrics: ${p.message}`))}finally{this.requestAbortControllers.delete(t)}}async queryRange(a,l,t,y){const k=new URLSearchParams({query:a,start:l.toString(),end:t.toString(),step:y.toString()}),p=new AbortController,x=setTimeout(()=>p.abort(),1e4);try{const f=`${this.baseUrl}/api/v1/query_range?${k}`,d=await fetch(f,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},signal:p.signal});if(clearTimeout(x),!d.ok)throw new Error(`Prometheus range query error: ${d.status} ${d.statusText}`);return await d.json()}catch(f){throw clearTimeout(x),console.error("Prometheus range query failed:",a,f),new Error(`Failed to fetch metrics range: ${f.message}`)}}async getTargets(){const a=new AbortController,l=setTimeout(()=>a.abort(),5e3);try{const t=await fetch(`${this.baseUrl}/api/v1/targets`,{method:"GET",headers:{Accept:"application/json"},signal:a.signal});if(clearTimeout(l),!t.ok)throw new Error(`Failed to fetch targets: ${t.status}`);return await t.json()}catch(t){throw clearTimeout(l),new Error(`Failed to fetch Prometheus targets: ${t.message}`)}}async isHealthy(){try{return(await fetch(`${this.baseUrl}/-/healthy`,{method:"GET",signal:AbortSignal.timeout(3e3)})).ok}catch{return!1}}clearCache(a){a?this.cache.delete(`query:${a}`):this.cache.clear()}cancelAllRequests(){this.requestAbortControllers.forEach(a=>a.abort()),this.requestAbortControllers.clear()}}const q=new nt,R={cpuUsage:'100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)',cpuCores:"count(count(node_cpu_seconds_total) by (cpu))",loadAverage1m:"node_load1",loadAverage5m:"node_load5",loadAverage15m:"node_load15",memoryTotal:"node_memory_MemTotal_bytes",memoryAvailable:"node_memory_MemAvailable_bytes",memoryUsagePercent:"100 * (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)",memoryUsageBytes:"node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes",diskUsagePercent:"100 - (node_filesystem_avail_bytes / node_filesystem_size_bytes * 100)",diskTotal:'node_filesystem_size_bytes{fstype!="tmpfs",mountpoint="/"}',diskUsed:'node_filesystem_size_bytes{fstype!="tmpfs",mountpoint="/"} - node_filesystem_free_bytes{fstype!="tmpfs",mountpoint="/"}',diskAvailable:'node_filesystem_avail_bytes{fstype!="tmpfs",mountpoint="/"}',networkReceiveBytesRate:'rate(node_network_receive_bytes_total{device!="lo"}[5m])',networkTransmitBytesRate:'rate(node_network_transmit_bytes_total{device!="lo"}[5m])',networkReceiveTotal:'sum(node_network_receive_bytes_total{device!="lo"})',networkTransmitTotal:'sum(node_network_transmit_bytes_total{device!="lo"})',uptime:"node_time_seconds - node_boot_time_seconds",serviceHealth:"up",prometheusTargets:"prometheus_target_health",zfsPoolHealth:"zfs_pool_health",zfsPoolUsagePercent:"zfs_pool_used_bytes / zfs_pool_size_bytes * 100",zfsPoolAvailableBytes:"zfs_pool_available_bytes",containerCount:'count(container_last_seen{name!=""})',containerTotalCpu:'sum(rate(container_cpu_usage_seconds_total{name!=""}[5m])) * 100',containerTotalMemory:'sum(container_memory_usage_bytes{name!=""})',containerCpuUsage:'sum(rate(container_cpu_usage_seconds_total{name!=""}[5m])) by (name)',containerMemoryUsage:'sum(container_memory_usage_bytes{name!=""}) by (name)',qbittorrentActiveDownloads:"qbittorrent_active_downloads",qbittorrentDownloadSpeed:"qbittorrent_download_speed_bytes",qbittorrentUploadSpeed:"qbittorrent_upload_speed_bytes"},ee={extractValue(s){var l,t;if(!s||s.length===0)return 0;const a=(t=(l=s[0])==null?void 0:l.value)==null?void 0:t[1];return a?parseFloat(a):0},extractValues(s){return s.map(a=>({label:Object.values(a.metric).join(" "),value:a.value?parseFloat(a.value[1]):0}))},formatBytes(s){if(s===0)return"0 B";const a=1024,l=["B","KB","MB","GB","TB"],t=Math.floor(Math.log(s)/Math.log(a));return parseFloat((s/Math.pow(a,t)).toFixed(2))+" "+l[t]},formatPercent(s){return`${Math.round(s*100)/100}%`},formatUptime(s){const a=Math.floor(s/86400),l=Math.floor(s%86400/3600),t=Math.floor(s%3600/60);return a>0?`${a}d ${l}h ${t}m`:l>0?`${l}h ${t}m`:`${t}m`}},dt=()=>{const s=b([{id:"prometheus",name:"Prometheus",description:"Metrics Collection System",status:"unknown",lastChecked:null,responseTime:null,job:"prometheus",instance:"localhost:9090",url:"http://192.168.0.99:9090"},{id:"node-exporter",name:"Node Exporter",description:"System Metrics Exporter",status:"unknown",lastChecked:null,responseTime:null,job:"node-exporter",instance:"proxmox-host",url:"http://192.168.0.99:9100",healthEndpoint:"http://192.168.0.99:9100"},{id:"cadvisor",name:"cAdvisor",description:"Container Metrics",status:"unknown",lastChecked:null,responseTime:null,job:"cadvisor",instance:"container-metrics",url:"http://192.168.0.99:8082/containers/",healthEndpoint:"http://192.168.0.99:8082"},{id:"zfs-exporter",name:"ZFS Exporter",description:"Storage Pool Metrics",status:"unknown",lastChecked:null,responseTime:null,job:"zfs-exporter",instance:"zfs-pools",url:"http://192.168.0.99:9101/metrics",healthEndpoint:"http://192.168.0.99:9101"},{id:"qbittorrent",name:"qBittorrent",description:"Torrent Client Web Interface",status:"unknown",lastChecked:null,responseTime:null,job:"qbittorrent",instance:"torrent-client",url:"http://192.168.0.111:8112/",healthEndpoint:"http://192.168.0.111:8112"},{id:"plex",name:"Plex Media Server",description:"Media Streaming Platform",status:"unknown",lastChecked:null,responseTime:null,job:"plex-server",instance:"media-server",url:"http://192.168.0.99:32400",healthEndpoint:"http://192.168.0.99:32400/identity"},{id:"mc-file-manager",name:"File Manager (mc)",description:"Midnight Commander in a web terminal",status:"online",lastChecked:new Date,responseTime:0,job:"local",instance:"local",url:"/file-manager",healthEndpoint:void 0},{id:"code-server",name:"Code Server",description:"VS Code in the Browser",status:"unknown",lastChecked:null,responseTime:null,job:"code-server",instance:"code-server",url:"http://192.168.0.250:8081",healthEndpoint:"http://192.168.0.250:8081"},{id:"proxmox",name:"Proxmox VE",description:"Virtualization Management",status:"unknown",lastChecked:null,responseTime:null,job:"proxmox",instance:"hypervisor",url:"https://192.168.0.99:8006",healthEndpoint:"https://192.168.0.99:8006/api2/json/version"},{id:"homeassistant",name:"Home Assistant",description:"Smart Home Automation",status:"unknown",lastChecked:null,responseTime:null,job:"homeassistant",instance:"smart-home",url:"http://192.168.0.99:8123",healthEndpoint:"http://192.168.0.99:8123"}]),a=b({totalServices:0,onlineServices:0,offlineServices:0,healthyPercentage:0,lastUpdateTime:null}),l=b(!1),t=b(""),y=b(!0),k=b(!1);let p=null;const x=m(()=>s.value.filter(e=>e.status==="online")),f=m(()=>s.value.filter(e=>e.status==="offline")),d=m(()=>s.value.filter(e=>e.status==="checking")),j=m(()=>s.value.filter(e=>e.status==="offline"&&["prometheus","node-exporter"].includes(e.id))),z=async e=>{try{const i=`up{job="${e.job}",instance="${e.instance}"}`,h=await q.query(i);if(h.status==="success"&&h.data.result.length>0){const C=ee.extractValue(h.data.result);e.status=C===1?"online":"offline",e.lastChecked=new Date,await I(e)}else e.status="unknown",e.lastChecked=new Date}catch(i){console.warn(`Prometheus check failed for ${e.name}:`,i),e.status="unknown",e.lastChecked=new Date}},P=async e=>{if(!e.healthEndpoint)return;const i=Date.now();try{const h=new AbortController,C=setTimeout(()=>h.abort(),5e3),g=await fetch(e.healthEndpoint,{method:"GET",signal:h.signal,mode:"no-cors"});clearTimeout(C),e.responseTime=Date.now()-i,e.lastChecked=new Date,e.status="online"}catch(h){e.responseTime=Date.now()-i,e.lastChecked=new Date,e.status="offline",console.warn(`HTTP health check failed for ${e.name}:`,h)}},I=async e=>{try{const i=[];switch(i.push(q.query("node_time_seconds - node_boot_time_seconds").catch(()=>null)),e.id){case"qbittorrent-exporter":i.push(q.query(R.qbittorrentActiveDownloads).catch(()=>null),q.query(R.qbittorrentDownloadSpeed).catch(()=>null),q.query(R.qbittorrentUploadSpeed).catch(()=>null));break;case"zfs-exporter":i.push(q.query(R.zfsPoolHealth).catch(()=>null),q.query(R.zfsPoolUsagePercent).catch(()=>null));break;case"cadvisor":i.push(q.query(R.containerCount).catch(()=>null),q.query(R.containerTotalCpu).catch(()=>null),q.query(R.containerTotalMemory).catch(()=>null));break}const h=await Promise.allSettled(i);e.metrics||(e.metrics={}),h.forEach((C,g)=>{var v;if(C.status==="fulfilled"&&((v=C.value)==null?void 0:v.status)==="success"){const n=ee.extractValue(C.value.data.result);switch(g){case 0:e.metrics.uptime=n;break;default:if(e.id==="qbittorrent-exporter")switch(g){case 1:e.metrics.customMetrics={...e.metrics.customMetrics,activeDownloads:n};break;case 2:e.metrics.customMetrics={...e.metrics.customMetrics,downloadSpeed:n};break;case 3:e.metrics.customMetrics={...e.metrics.customMetrics,uploadSpeed:n};break}else if(e.id==="cadvisor")switch(g){case 1:e.metrics.customMetrics={...e.metrics.customMetrics,containerCount:n};break;case 2:e.metrics.customMetrics={...e.metrics.customMetrics,cpuUsage:n};break;case 3:e.metrics.customMetrics={...e.metrics.customMetrics,memoryUsage:n};break}break}}})}catch(i){console.warn(`Failed to fetch metrics for ${e.name}:`,i)}},T=async e=>{e.status="checking",await z(e),e.status==="unknown"&&e.healthEndpoint&&await P(e)},E=async()=>{try{l.value=!0,t.value="";const e=s.value.map(i=>T(i));await Promise.allSettled(e),F()}catch(e){console.error("Failed to check services health:",e),t.value=e instanceof Error?e.message:"Unknown error"}finally{l.value=!1}},F=()=>{const e=s.value.length,i=x.value.length,h=f.value.length;a.value={totalServices:e,onlineServices:i,offlineServices:h,healthyPercentage:e>0?i/e*100:0,lastUpdateTime:new Date}},V=async e=>{const i=s.value.find(h=>h.id===e);i&&(await T(i),F())},L=async()=>{k.value=!0,await E(),k.value=!1},U=()=>{p||(E(),p=setInterval(E,6e4))},$=()=>{p&&(clearInterval(p),p=null)},u=()=>{y.value=!y.value,y.value?U():$()},r=e=>s.value.find(i=>i.id===e),_=e=>s.value.filter(i=>i.status===e);return se(()=>{$()}),{services:H(s),serviceMetrics:H(a),isLoading:H(l),error:H(t),isAutoRefreshEnabled:H(y),isRefreshing:H(k),onlineServices:x,offlineServices:f,checkingServices:d,criticalServices:j,checkServiceHealth:T,checkAllServicesHealth:E,refreshService:V,refreshAllServices:L,startAutoRefresh:U,stopAutoRefresh:$,toggleAutoRefresh:u,getServiceById:r,getServicesByStatus:_}};export{ut as S,B as c,dt as u};
