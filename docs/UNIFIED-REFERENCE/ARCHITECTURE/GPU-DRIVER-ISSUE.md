# NVIDIA GPU Driver Installation Issue Report

## Issue Summary
NVIDIA driver fails to load on Proxmox VE due to kernel module struct size mismatch.

## System Configuration
- **Kernel**: 6.14.8-2-pve (future version - system time issue suspected)
- **GPUs**: RTX 5070 Ti (01:00.0) + GTX 970 (04:00.0)
- **IOMMU**: Properly configured, GPUs in separate groups
- **Driver**: NVIDIA 550.163.01 (via apt)

## Root Cause
**Kernel Module Struct Size Mismatch**
```
module nvidia: .gnu.linkonce.this_module section size must match the kernel's built struct module size at run time
```

This error indicates the NVIDIA kernel module was compiled with different kernel headers/configuration than the running kernel.

## Diagnosis Steps Completed
1. ✅ Verified IOMMU groups configured correctly
2. ✅ Blacklisted nouveau driver
3. ✅ Installed NVIDIA packages via apt
4. ✅ Rebuilt DKMS modules for current kernel
5. ✅ Updated initramfs and GRUB
6. ❌ Module load fails with struct size mismatch

## Critical Finding
**Kernel Version Anomaly**: System reports kernel 6.14.8-2-pve (dated 2025-07-22), which is a future version. This suggests:
1. System time/date configuration issue
2. Custom/experimental kernel build
3. Potential repository misconfiguration

## Resolution Options

### Option 1: System Reboot (Recommended)
```bash
# Reboot to ensure kernel and modules sync
ssh root@192.168.0.99 "reboot"

# After reboot, verify:
ssh root@192.168.0.99 "nvidia-smi"
```

### Option 2: Downgrade Kernel
```bash
# Boot into older kernel (6.8.12-13-pve available)
# Edit GRUB default kernel selection
ssh root@192.168.0.99 "update-grub"
```

### Option 3: Manual Driver Installation
```bash
# Use NVIDIA .run installer with kernel source override
cd /root
./NVIDIA-Linux-x86_64-550.127.05.run \
  --kernel-source-path=/usr/src/linux-headers-$(uname -r) \
  --no-questions \
  --silent
```

## Workaround for Immediate GPU Access

### For Container GPU Access (Without nvidia-smi)
```bash
# Pass GPU device directly to container
docker run --device /dev/dri:/dev/dri \
          --device /dev/nvidia0:/dev/nvidia0 \
          --device /dev/nvidiactl:/dev/nvidiactl \
          container:tag
```

### For VM GPU Passthrough
```bash
# GPUs ready for passthrough via IOMMU groups
# RTX 5070 Ti: Group 2 (01:00.0, 01:00.1)
# GTX 970: Group 14 (04:00.0, 04:00.1)
```

## Impact on Services
- **Plex**: Can use software transcoding until GPU drivers fixed
- **AI/LLM Services**: Blocked until NVIDIA drivers operational
- **Gaming VM**: GPU passthrough ready once drivers load

## Next Steps
1. **Immediate**: Document in main worktree for coordination
2. **Short-term**: Schedule maintenance window for reboot
3. **Long-term**: Investigate kernel version anomaly

## Debug SME Notes
- Module compilation succeeds but runtime struct mismatch indicates ABI incompatibility
- DKMS builds successfully but kernel refuses module insertion
- This is typically resolved by reboot or kernel alignment

---
*Generated by Debug SME Agent - 2025-08-25*
*Issue Status: Diagnosed, Awaiting Reboot*